<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Club Events | Campus Connect</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body class="dashboard-body">

<div class="layout">

  <aside class="sidebar">
    <div class="logo-icon">C</div>
    <a href="/club/">ğŸ  Dashboard</a>
    <a href="/club/members">ğŸ‘¥ Members</a>
    <a href="/club/events">ğŸ‰ Events</a>
    <a href="/club/announcements">ğŸ“¢ Announcements</a>
    <a href="/logout">ğŸšª Logout</a>
  </aside>

  <main class="dashboard">

    <section class="greeting">
      <h1>ğŸ‰ Club Events</h1>
      <p>Create events and view registrations</p>
    </section>

    <section class="main-grid">

      <!-- CREATE EVENT -->
      <div class="card">
        <h2>â• Create New Event</h2>
        <div style="display:flex; flex-direction:column; gap:12px; margin-top:16px;">
          <input id="eTitle" placeholder="Event Title" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
          <textarea id="eDesc" placeholder="Description" rows="2"
            style="padding:12px; border-radius:10px; border:1px solid var(--border); font-family:inherit; resize:vertical;"></textarea>
          <select id="eCategory" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
            <option value="Cultural">ğŸ‰ Cultural</option>
            <option value="Technical">ğŸ’» Technical</option>
            <option value="Sports">âš½ Sports</option>
            <option value="Academic">ğŸ“ Academic</option>
            <option value="Social">ğŸ¤ Social</option>
          </select>
          <label style="color:var(--muted); font-size:13px;">Event Date</label>
          <input type="date" id="eDate" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
          <input type="time" id="eTime" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
          <input id="eVenue" placeholder="Venue" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
          <input type="number" id="eSeats" placeholder="Available Seats" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
          <button onclick="createEvent()"
            style="padding:12px; border-radius:10px; border:none; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; font-weight:700; cursor:pointer;">
            Create Event
          </button>
          <p id="eventMsg" style="font-weight:600;"></p>
        </div>
      </div>

      <!-- MY EVENTS LIST -->
      <div class="card">
        <h2>ğŸ“‹ My Club Events</h2>
        <div id="eventsList" style="display:flex; flex-direction:column; gap:12px; margin-top:16px; max-height:500px; overflow-y:auto;"></div>
      </div>

    </section>

    <!-- REGISTRATIONS PANEL -->
    <section class="card" id="registrationsPanel" style="display:none; width:100%; flex:none;">
      <h2>ğŸ‘¥ Registrations for: <span id="regEventTitle" style="color:var(--primary);"></span></h2>
      <button onclick="document.getElementById('registrationsPanel').style.display='none'"
        style="margin-bottom:16px; padding:8px 16px; border-radius:8px; border:1px solid var(--border); cursor:pointer; background:white;">
        â† Back
      </button>
      <div id="regList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </section>

  </main>
</div>

<script>

document.addEventListener("DOMContentLoaded", loadEvents);

function createEvent() {
  const title = document.getElementById("eTitle").value;
  const description = document.getElementById("eDesc").value;
  const category = document.getElementById("eCategory").value;
  const event_date = document.getElementById("eDate").value;
  const event_time = document.getElementById("eTime").value;
  const venue = document.getElementById("eVenue").value;
  const seats = document.getElementById("eSeats").value;
  const msg = document.getElementById("eventMsg");

  if (!title || !event_date) {
    msg.style.color = "red"; msg.innerText = "Title and date required"; return;
  }

  fetch("/club/events/create", {
    method: "POST", credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, description, category, event_date, event_time, venue, seats: seats ? parseInt(seats) : null })
  }).then(r => r.json()).then(d => {
    if (d.success) {
      msg.style.color = "green"; msg.innerText = "âœ… Event created!";
      document.getElementById("eTitle").value = "";
      document.getElementById("eDesc").value = "";
      document.getElementById("eDate").value = "";
      document.getElementById("eVenue").value = "";
      document.getElementById("eSeats").value = "";
      loadEvents();
    } else {
      msg.style.color = "red"; msg.innerText = d.message || "Failed";
    }
  });
}

function loadEvents() {
  fetch("/club/events/list", { credentials: "include" })
    .then(r => r.json())
    .then(events => {
      const el = document.getElementById("eventsList");
      if (!events.length) { el.innerHTML = "<p style='color:var(--muted);'>No events yet. Create one!</p>"; return; }
      el.innerHTML = events.map(e => `
        <div style="padding:16px; border-radius:12px; background:var(--bg); border-left:4px solid var(--primary);">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
            <div>
              <strong>${e.title}</strong>
              <p style="font-size:13px; color:var(--muted); margin-top:4px;">
                ğŸ“… ${e.event_date ? e.event_date.slice(0,10) : "â€”"}
                ${e.event_time ? " â€¢ " + e.event_time.slice(0,5) : ""}
                ${e.venue ? " â€¢ ğŸ“ " + e.venue : ""}
              </p>
              <p style="font-size:12px; color:var(--muted); margin-top:2px;">
                ${e.category || "General"} â€¢ ${e.registration_count || 0} registered
              </p>
            </div>
            <button onclick="viewRegistrations(${e.id}, '${e.title.replace(/'/g,"\\'")}' )"
              style="padding:8px 14px; border-radius:8px; border:none; background:var(--primary); color:white; font-size:13px; cursor:pointer; white-space:nowrap;">
              ğŸ‘¥ View Registrations
            </button>
          </div>
        </div>
      `).join("");
    });
}

function viewRegistrations(eventId, eventTitle) {
  document.getElementById("regEventTitle").innerText = eventTitle;
  document.getElementById("registrationsPanel").style.display = "block";
  document.getElementById("registrationsPanel").scrollIntoView({ behavior: "smooth" });

  fetch(`/club/events/registrations/${eventId}`, { credentials: "include" })
    .then(r => r.json())
    .then(regs => {
      const el = document.getElementById("regList");
      if (!regs.length) { el.innerHTML = "<p style='color:var(--muted);'>No registrations yet</p>"; return; }
      el.innerHTML = regs.map(r => `
        <div style="padding:14px; border-radius:10px; background:var(--bg); display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
          <strong>${r.username}</strong>
          <span style="color:var(--muted); font-size:13px;">${r.email}</span>
          <span style="color:var(--muted); font-size:13px;">PRN: ${r.prn || "â€”"}</span>
          <span style="color:var(--muted); font-size:13px;">${r.class_name || "â€”"}</span>
        </div>
      `).join("");
    });
}

</script>
</body>
</html>